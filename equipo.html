<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DB Football">
  <link rel="manifest" href="/db-futbol/manifest.json">
  <link rel="apple-touch-icon" href="icono.png">
  <title>Equipo</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ... (Mantenemos tus estilos CSS intactos) ... */
    .team-container { width: 100%; margin: 30px auto; display: flex; flex-direction: column; gap: 20px; padding: 0 20px; flex: 1; justify-content: center; }
    .team-name { font-size: 1.8rem; text-align: center; color: white; background-color: #222; padding: 25px; border-radius: 10px; font-weight: bold; }
    .titleInfo { font-size: 1rem; background-color: #222; color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .detailsDiv { display: flex; justify-content: space-around; gap: 10px; }
    .partido { display: flex; width: 100%; font-weight: bold; font-size: 1rem; background-color: #222; color: white; padding: 15px; border-radius: 10px; align-items: center; justify-content: center; }
    .verde { color: #00ff88; }
    .nombreEquipo { font-size: 15px; text-align: center; }
  </style>
</head>
<body>
  <header class="navbar">
    <h1 class="logo">DB Football 2025/26</h1>
    <nav class="menu">
      <a href="index.html">Inicio</a>
      <a href="equipos.html">Equipos</a>
    </nav>
  </header>

  <div id="teamInfo" class="team-container"></div>

  <footer class="footer">
    <p>© 2025 DB Football. Todos los derechos reservados.</p>
  </footer>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { firebaseConfig } from "./firebaseConfig.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const teamName = params.get("team");
  const teamContainer = document.getElementById("teamInfo");

  // 1. Mapeo para los IDs de los documentos de seguimiento (Scraping)
  const mapeoIdsSeguimiento = {
    "equipo_sd_eibar_b": "equipo_eibar_b",
    "equipo_indartsu_club": "equipo_indartsu",
    "equipo_cd_derio": "equipo_derio",
    "equipo_fc_cartagena": "equipo_cartagena"
  };

  // 2. Mapeo para los IDs de la colección "Equipos" (Base de datos principal)
  const mapeoIdsEquiposBase = {
    "SD Eibar B": "EQ01",
    "CD Derio": "EQ02",
    "Indartsu Club": "EQ03",
    "FC Cartagena": "EQ04"
    // Añade aquí el resto según los tengas en Firebase
  };

  const crearIdDocSeguimiento = (tipo, nombre) => {
      const idOriginal = `${tipo}_${nombre.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '')}`;
      return mapeoIdsSeguimiento[idOriginal] || idOriginal;
  };

  async function cargarEquipo() {
    if (!teamName) {
      teamContainer.innerHTML = "<p>No se especificó equipo.</p>";
      return;
    }

    // ID para seguimiento_futbol (ej: equipo_derio)
    const docStatsId = crearIdDocSeguimiento("equipo", teamName);
    const refStats = doc(db, "seguimiento_futbol", docStatsId);
    
    // ID para la colección Equipos (ej: EQ02)
    const idEquipoBase = mapeoIdsEquiposBase[teamName] || teamName;
    const refEquipoBase = doc(db, "Equipos", idEquipoBase);

    try {
      // Cargamos ambos documentos en paralelo
      const [snapStats, snapEquipoBase] = await Promise.all([
        getDoc(refStats),
        getDoc(refEquipoBase)
      ]);

      if (snapStats.exists()) {
        const dataStats = snapStats.data();
        
        // --- OBTENER NOMBRE REAL DE LA COLECCIÓN EQUIPOS ---
        let nombreOficial = teamName; 
        if (snapEquipoBase.exists()) {
          nombreOficial = snapEquipoBase.data().nombre; // Campo 'nombre' de la col Equipos
        }

        teamContainer.innerHTML = "";

        // --- 1. Título del Equipo ---
        const nameDiv = document.createElement("div");
        nameDiv.className = "team-name";
        nameDiv.textContent = nombreOficial;
        teamContainer.appendChild(nameDiv);

        const { ultimo, proximo } = dataStats;

        if (teamName != "Indartsu Club" && teamName != "FC Cartagena") {
          // --- 2. Bloque Último Partido ---
          if (ultimo) {
            const lastTitle = document.createElement("div");
            lastTitle.className = "titleInfo";

            var jornadaLimpia = ultimo.infoJornada
              .replace(/schedule/gi, '')
              .replace(/get_app/gi, '')
              .trim();

            jornadaLimpia = jornadaLimpia.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
                const dia = d.padStart(2, '0');
                const mes = m.padStart(2, '0');
                return `${dia}/${mes}/${y}`;
            });

            const jornada = jornadaLimpia.split(' - ')[0].split(' - ')[0];
            const fecha = jornadaLimpia.split(' - ')[1].split(' - ')[0];

            lastTitle.innerHTML = `<h3>${jornada} (${fecha})</h3>`;
            teamContainer.appendChild(lastTitle);

            const lastDetails = document.createElement("div");
            lastDetails.className = "detailsDiv";
            
            const esCasa = ultimo.rival.includes("(C)");
            const rivalLimpio = ultimo.rival.replace("(C)", "").replace("(F)", "").trim();

            lastDetails.innerHTML = `
                <div class="nombreEquipo partido ${esCasa ? 'verde' : ''}">${esCasa ? nombreOficial : rivalLimpio}</div>
                <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content; white-space: nowrap;">${ultimo.resultado}</div>
                <div class="nombreEquipo partido ${!esCasa ? 'verde' : ''}">${!esCasa ? nombreOficial : rivalLimpio}</div>
            `;
            teamContainer.appendChild(lastDetails);
          }

          // --- 3. Bloque Próximo Partido ---
          if (proximo) {
              const nextTitle = document.createElement("div");
              nextTitle.className = "titleInfo";

              var jornadaLimpia = proximo.infoJornada
                  .replace(/schedule/gi, '')
                  .replace(/get_app/gi, '')
                  .trim();

              jornadaLimpia = jornadaLimpia.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
                  const dia = d.padStart(2, '0');
                  const mes = m.padStart(2, '0');
                  return `${dia}/${mes}/${y}`;
              });

              const jornada = jornadaLimpia.split(' - ')[0];
              let fecha = jornadaLimpia.split(' - ')[1];

              // --- LÓGICA DE RESTAR DÍA SI ES SÁBADO (S-) ---
              if (proximo.resultado.includes("S-")) {
                  // 1. Extraer día, mes y año del string "DD/MM/YYYY"
                  const [d, m, y] = fecha.split('/').map(Number);
                  // 2. Crear objeto fecha (el mes en JS empieza en 0, por eso m-1)
                  let fechaObj = new Date(y, m - 1, d);
                  // 3. Restar un día
                  fechaObj.setDate(fechaObj.getDate() - 1);
                  // 4. Volver a formatear a "DD/MM/YYYY"
                  const nuevoDia = String(fechaObj.getDate()).padStart(2, '0');
                  const nuevoMes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                  const nuevoAnio = fechaObj.getFullYear();
                  fecha = `${nuevoDia}/${nuevoMes}/${nuevoAnio}`;
              }

              // Ahora limpiamos el resultado para el HTML
              proximo.resultado = proximo.resultado.replace("S-", "");
              proximo.resultado = proximo.resultado.replace("D-", "");

              nextTitle.innerHTML = `<h3>${jornada} (${fecha})</h3>`;
              teamContainer.appendChild(nextTitle);

              const nextDetails = document.createElement("div");
              nextDetails.className = "detailsDiv";

              const esCasaProx = proximo.rival.includes("(C)");
              const rivalProxLimpio = proximo.rival.replace("(C)", "").replace("(F)", "").trim();

              nextDetails.innerHTML = `
                  <div class="nombreEquipo partido ${esCasaProx ? 'verde' : ''}">${esCasaProx ? nombreOficial : rivalProxLimpio}</div>
                  <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content;">${proximo.resultado}</div>
                  <div class="nombreEquipo partido ${!esCasaProx ? 'verde' : ''}">${!esCasaProx ? nombreOficial : rivalProxLimpio}</div>
              `;
              teamContainer.appendChild(nextDetails);
          }
        } else if (teamName == "FC Cartagena") {
          // --- 2. Bloque Último Partido ---
          if (ultimo) {
            const lastTitle = document.createElement("div");
            lastTitle.className = "titleInfo";

            var jornadaLimpia = ultimo.infoJornada
              .replace(/schedule/gi, '')
              .replace(/get_app/gi, '')
              .trim();

            jornadaLimpia = jornadaLimpia.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
                const dia = d.padStart(2, '0');
                const mes = m.padStart(2, '0');
                return `${dia}/${mes}/${y}`;
            });

            const jornada = jornadaLimpia.split(' - ')[0].split(' - ')[0];
            const fecha = jornadaLimpia.split(' - ')[1].split(' - ')[0];

            lastTitle.innerHTML = `<h3>${jornada} (${fecha})</h3>`;
            teamContainer.appendChild(lastTitle);

            const lastDetails = document.createElement("div");
            lastDetails.className = "detailsDiv";
            
            const esCasa = ultimo.rival.includes("(C)");
            const rivalLimpio = ultimo.rival.replace("(C)", "").replace("(F)", "").trim();

            lastDetails.innerHTML = `
                <div class="nombreEquipo partido ${esCasa ? 'verde' : ''}">${esCasa ? nombreOficial : rivalLimpio}</div>
                <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content; white-space: nowrap;">${ultimo.resultado}</div>
                <div class="nombreEquipo partido ${!esCasa ? 'verde' : ''}">${!esCasa ? nombreOficial : rivalLimpio}</div>
            `;
            teamContainer.appendChild(lastDetails);
          }

          // --- 3. Bloque Próximo Partido ---
          if (proximo) {
            const nextTitle = document.createElement("div");
            nextTitle.className = "titleInfo";

            var jornadaLimpia = proximo.infoJornada
              .replace(/schedule/gi, '')
              .replace(/get_app/gi, '')
              .trim();

            jornadaLimpia = jornadaLimpia.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
                const dia = d.padStart(2, '0');
                const mes = m.padStart(2, '0');
                return `${dia}/${mes}/${y}`;
            });

            const jornada = jornadaLimpia.split(' - ')[0].split(' - ')[0];
            const fecha = jornadaLimpia.split(' - ')[1].split(' - ')[0];

            nextTitle.innerHTML = `<h3>${jornada} (${fecha})</h3>`;
            teamContainer.appendChild(nextTitle);

            const nextDetails = document.createElement("div");
            nextDetails.className = "detailsDiv";

            const esCasaProx = proximo.rival.includes("(C)");
            const rivalProxLimpio = proximo.rival.replace("(C)", "").replace("(F)", "").trim();
            proximo.resultado = proximo.resultado.replace("S-", "");
            proximo.resultado = proximo.resultado.replace("D-", "");

            nextDetails.innerHTML = `
                <div class="nombreEquipo partido ${esCasaProx ? 'verde' : ''}">${esCasaProx ? nombreOficial : rivalProxLimpio}</div>
                <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content;">${proximo.resultado}</div>
                <div class="nombreEquipo partido ${!esCasaProx ? 'verde' : ''}">${!esCasaProx ? nombreOficial : rivalProxLimpio}</div>
            `;
            teamContainer.appendChild(nextDetails);
          }
        } else {
          // --- 2. Bloque Último Partido ---
        if (ultimo) {
          const lastTitle = document.createElement("div");
          lastTitle.className = "titleInfo";

          var jornadaLimpia = ultimo.infoJornada
            .replace(/schedule/gi, '')
            .replace(/get_app/gi, '')
            .trim();

          jornadaLimpia = jornadaLimpia.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
              const dia = d.padStart(2, '0');
              const mes = m.padStart(2, '0');
              return `${dia}/${mes}/${y}`;
          });

          const jornada = jornadaLimpia.split(' - ')[0].split(' - ')[0];
          var fecha = jornadaLimpia.split(' - ')[1];
          fecha = fecha.replace("-", "/").replace("-", "/");

          lastTitle.innerHTML = `<h3>${jornada} (${fecha})</h3>`;
          teamContainer.appendChild(lastTitle);

          const lastDetails = document.createElement("div");
          lastDetails.className = "detailsDiv";
          
          const esCasa = ultimo.rival.includes("(C)");
          const rivalLimpio = ultimo.rival.replace("(C)", "").replace("(F)", "").trim();

          ultimo.resultado = ultimo.resultado.replace("P", "");
          ultimo.resultado = ultimo.resultado.replace("G", "");

          const rival = rivalLimpio.replace('"', "").replace('"', '').trim();

          lastDetails.innerHTML = `
              <div class="nombreEquipo partido ${esCasa ? 'verde' : ''}">${esCasa ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rival)}</div>
              <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content; white-space: nowrap;">${ultimo.resultado}</div>
              <div class="nombreEquipo partido ${!esCasa ? 'verde' : ''}">${!esCasa ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rival)}</div>
          `;
          teamContainer.appendChild(lastDetails);
        }

        // --- 3. Bloque Próximo Partido ---
        if (proximo) {
          const nextTitle = document.createElement("div");
          nextTitle.className = "titleInfo";

          var jornadaLimpia = proximo.infoJornada
            .replace(/schedule/gi, '')
            .replace(/get_app/gi, '')
            .trim();

          jornadaLimpia = jornadaLimpia.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, (match, d, m, y) => {
              const dia = d.padStart(2, '0');
              const mes = m.padStart(2, '0');
              return `${dia}/${mes}/${y}`;
          });

          const jornada = jornadaLimpia.split(' - ')[0].split(' - ')[0];
          var fecha = jornadaLimpia.split(' - ')[1].split(' - ')[0];
          fecha = fecha.replace("-", "/").replace("-", "/");

          nextTitle.innerHTML = `<h3>${jornada} (${fecha})</h3>`;
          teamContainer.appendChild(nextTitle);

          const nextDetails = document.createElement("div");
          nextDetails.className = "detailsDiv";

          const esCasaProx = proximo.rival.includes("(C)");
          const rivalProxLimpio = proximo.rival.replace("(C)", "").replace("(F)", "").trim();

          const matchHora = proximo.resultado.match(/\d{2}:\d{2}/);
          const horaLimpia = matchHora ? matchHora[0] : "-";

          const rivalProx = rivalProxLimpio.replace('"', "").replace('"', '').trim();

          nextDetails.innerHTML = `
              <div class="nombreEquipo partido ${esCasaProx ? 'verde' : ''}">${esCasaProx ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rivalProx)}</div>
              <div class="partido" style="font-size: 25px; font-style: italic; width: fit-content;">${horaLimpia}</div>
              <div class="nombreEquipo partido ${!esCasaProx ? 'verde' : ''}">${!esCasaProx ? formatearNombreEquipo(nombreOficial) : formatearNombreEquipo(rivalProx)}</div>
          `;
          teamContainer.appendChild(nextDetails);
        }
        }

      } else {
        teamContainer.innerHTML = `<p>No se encontraron estadísticas para este equipo.</p>`;
      }
    } catch (error) {
      console.error("Error Firebase:", error);
      teamContainer.innerHTML = "<p>Error al conectar con la base de datos.</p>";
    }
  }

  function formatearNombreEquipo(texto) {
    if (!texto) return "";

    return texto.toLowerCase().split(' ').map(palabra => {
        // Si la palabra contiene comillas, la devolvemos en mayúsculas
        if (palabra.includes('"')) {
            return palabra.toUpperCase();
        }
        // Si es una palabra normal, ponemos en mayúscula solo la primera letra
        return palabra.charAt(0).toUpperCase() + palabra.slice(1);
    }).join(' ');
}

  cargarEquipo();
</script>
  
</body>
</html>